@page
@model WEB.Pages.Contratos.CreateModel
@{
    ViewData["Title"] = "Crear Nuevo Contrato";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">
                            <i class="fas fa-file-contract me-2"></i>@ViewData["Title"]
                        </h3>
                        <a asp-page="Index" class="btn btn-light btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>Volver al listado
                        </a>
                    </div>
                </div>

                <div class="card-body">
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <div id="errorContainer" class="alert alert-danger alert-dismissible fade show mb-4" style="display: none;">
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        <div id="errorContent"></div>
                    </div>

                    <form method="post" id="contratoForm" class="needs-validation" novalidate>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="Contrato.IdPropiedad" class="form-label">Propiedad *</label>
                                <select asp-for="Contrato.IdPropiedad" asp-items="Model.Propiedades"
                                        class="form-select" required>
                                    <option value="">-- Seleccionar propiedad --</option>
                                </select>
                                <span asp-validation-for="Contrato.IdPropiedad" class="text-danger"></span>
                                <div class="invalid-feedback">Por favor seleccione una propiedad</div>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="Contrato.IdCliente" class="form-label">Cliente *</label>
                                <select asp-for="Contrato.IdCliente" asp-items="Model.Clientes"
                                        class="form-select" required>
                                    <option value="">-- Seleccionar cliente --</option>
                                </select>
                                <span asp-validation-for="Contrato.IdCliente" class="text-danger"></span>
                                <div class="invalid-feedback">Por favor seleccione un cliente</div>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="Contrato.Fecha" class="form-label">Fecha *</label>
                                <input asp-for="Contrato.Fecha" class="form-control" type="date" required />
                                <span asp-validation-for="Contrato.Fecha" class="text-danger"></span>
                                <div class="invalid-feedback">Por favor ingrese una fecha válida</div>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="Contrato.Monto" class="form-label">Monto *</label>
                                <div class="input-group has-validation">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="Contrato.Monto" class="form-control"
                                           type="number" step="0.01" min="0.01" required
                                           placeholder="Ej: 1500.00" />
                                    <span asp-validation-for="Contrato.Monto" class="text-danger"></span>
                                    <div class="invalid-feedback">Por favor ingrese un monto válido</div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="Contrato.IdEstado" class="form-label">Estado *</label>
                                <select asp-for="Contrato.IdEstado" asp-items="Model.EstadosContrato"
                                        class="form-select" required>
                                    <option value="">-- Seleccionar estado --</option>
                                </select>
                                <span asp-validation-for="Contrato.IdEstado" class="text-danger"></span>
                                <div class="invalid-feedback">Por favor seleccione un estado</div>
                            </div>

                            <div class="col-12 mt-4">
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <button type="reset" class="btn btn-outline-secondary me-md-2">
                                        <i class="fas fa-undo me-1"></i>Limpiar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i>Guardar Contrato
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('contratoForm');
            const errorContainer = document.getElementById('errorContainer');
            const errorContent = document.getElementById('errorContent');
            const submitBtn = form.querySelector('button[type="submit"]');

            const fechaInput = document.querySelector('input[name="Contrato.Fecha"]');
            if (fechaInput) {
                const today = new Date().toISOString().split('T')[0];
                fechaInput.setAttribute('max', today);
                fechaInput.value = today;
            }

            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                errorContainer.style.display = 'none';

                if (!form.checkValidity()) {
                    e.stopPropagation();
                    form.classList.add('was-validated');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Guardando...';

                try {
                    const formData = new FormData(form);
                    const response = await fetch('', {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: formData
                    });

                    if (response.redirected) {
                        window.location.href = response.url;
                    } else if (!response.ok) {
                        const errorData = await response.json();
                        showErrors(errorData);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showErrors({ error: 'Error de conexión con el servidor' });
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Guardar Contrato';
                }
            });

            function showErrors(errors) {
                errorContent.innerHTML = '';

                if (errors.errors) {
                    for (const [key, value] of Object.entries(errors.errors)) {
                        const errorItem = document.createElement('p');
                        errorItem.textContent = `${value}`;
                        errorContent.appendChild(errorItem);
                    }
                } else if (errors.error) {
                    const errorItem = document.createElement('p');
                    errorItem.textContent = errors.error;
                    errorContent.appendChild(errorItem);
                }

                errorContainer.style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
    </script>
}